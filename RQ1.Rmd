---
title: "Analysis"
output:
  html_document: 
    toc: yes
    toc_depth: 4
    theme: flatly
  pdf_document:
    toc: yes
  html_notebook: 
    toc: yes
    theme: flatly
    toc_depth: 5
    highlight: pygments
editor_options:
  chunk_output_type: inline
---

```{r, include = FALSE}
library(dplyr)
require(globaltest)
require(GlobalAncova)
load("data/data.Rdata")
load("data/clinical.Rdata")
```
## RQi: Differential expression of metabolites per ApoE genotype

### Global test

Performing a Global Test on the serum metabolites of AD patients, correcting for sex (Ho: E4 status has no effect on metabolite levels, Ha: it has an effect), yields a significant difference (p = 0.046) between E4 carriers and non-carriers. Testing for ApoE4 dose effects have an effect on metabolite levels showed no significant nuance.

```{r}
AD <- subset(df, Diagnosis == "Probable AD")
AD$sex <- as.numeric(AD$sex) -1
# Testing for effects
gt.b <- globaltest::gt(E4 ~ 1, E4 ~ . -E4dose -Diagnosis -target, data = AD)
gt.b
globaltest::covariates(gt.b)
```

```{r gt}
# Multinomial outcome
AD$E4dose <- as.factor(AD$E4dose)
gt.m <- globaltest::gt(E4dose ~ 1, E4dose ~ .-E4 -Diagnosis -target, data = AD)
gt.m
# globaltest::covariates(gt.m)
```
### Hierarchical global ANCOVA testing on generalised linear models
```{r}
# get a hierarchy for variables
dend <- as.dendrogram(hclust(dist(t(df[,1:230]))))
# hierarchical test for ApoE4 presence and AD
set.seed(555)
hierGA <- gGlobalAncova.hierarchical(df[,1:230], H = dend, formula.full = ~target +sex, model.dat = df, alpha = 0.05, perm = 100)
results(hierGA)
# get names of significant clusters
sigEndnodes(hierGA)
```
### Nested Linear Models
Metabolite-level models to test for ApoE4 dose effects.
```{r}
mtest <- function(Y, x, ...) {
  ### Analysis of Variance (ANOVA)
  df <- cbind(Y, x, ...)
  ncol <- ncol(Y)
  covariates <- names(...)
  summaries <- purrr::map(df[, 1:ncol], ~ {
    frm <- as.formula(paste0(".x ~", paste(covariates, collapse = "+")))
    rm <- lm(frm, data = df)
    ffm <- as.formula(paste0(".x ~ x +", paste(covariates, collapse = "+")))
    fm <- lm(ffm, data = df)
    anova(rm, fm)
  })
  ## Correction for Multiple Testing
  # Create a list to store the p-values
  p_values <- list(1:ncol)
  # Extract the p-values of the F-tests from the aov summaries list and store them in p_values
  for (i in 1:ncol) {
    p_values[[i]] <- summaries[[i]][["Pr(>F)"]][[2]]
  }
  # Coerce p_values to dataframe and transpose it
  p_values <- t(data.frame(p_values))

  # Set as row names the metabolites
  p_values <- data.frame(p_values, row.names = colnames(Y))

  # Calculate the FDR-adjusted p-values
  p_values$p_adj <- p.adjust(p_values[, ], method = "fdr")
  # Filter out the non-significant (a=0.05) FDR-adjusted p-values
  sig <- dplyr::filter(p_values, p_values < 0.05)
  return(sig[order(sig$p_adj),])
}
```
Testing in SCD and AD
```{r}
#Testing in all samples
Y <- df[, 1:230]
clinical$V_MMSE <- NULL
target <- df$target

##Testing for effects of presence of ApoE4 in combination with AD diagnosis
mtest(Y=Y,x= target, clinical)


##Testing for effects of ApoE4 dose
E4dose <- df$E4dose
mtest(Y, E4dose, clinical)
```

Testing for ApoE4 dose effects in AD group only
```{r}
#Testing in all samples
ADY <- AD[, 1:230]
clinical$V_MMSE <- NULL
ADE4dose <- AD$E4dose
ADclinical <- clinical[df$Diagnosis == "Probable AD",]

##Testing for effects of ApoE4 dose
mtest(ADY, ADE4dose, ADclinical)
```
