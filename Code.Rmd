---
title: "ApoE4 dose effects on serum metabolome in Alzheimer's Disease"
subtitle: "a Data Science approach"
author: "George Miliarakis, MSc Thesis"
date: "15-01-2024"
output:
    tufte::tufte_html: default
    toc: yes
    toc_depth: 4
    highlight: pygments
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "", warning = FALSE, message = FALSE
)
```

```{r packages, include=FALSE}
require(heatmaply)
require(globaltest)
require(GlobalAncova)
require(ggplot2)
require(ggthemes)
require(plotly)
require(furrr)
require(caret)
require(dplyr)
require(e1071)
require(FMradio)
require(pROC)
require(xgboost)
require(rpart)
require(DMwR2)
require(nnet)
require(rags2ridges)
```

## Data Exploration

The (interactive) correlation heatmap reveals very high correlation among aminoacids and TG compounds.

```{r heatmap}
load("data/data.Rdata")
X <- df[df$Diagnosis == "Probable AD", 1:230]
C <- round(cor(X), 2)

heatmaply_cor(C, color = viridis, plot_method = "plotly", dendrogram = F, reorderfun = sort.default(d,w), main = "Correlation Heatmap", file = "heatmap.html", colorbar_thickness = 15, colorbar_len = 0.5)
```

## Differential expression of metabolites per ApoE genotype

### Global test in AD group

Performing a Global Test on the serum metabolites of AD patients, correcting for sex (Ho: E4 status has no effect on metabolite levels, Ha: it has an effect), yields a significant difference (p = 0.029 ) between E4 carriers and non-carriers. The presence of ApoE4, correcting for sex seems to have an effect on the metabolites shown in the plot below. The most significantly affected metabolites are triglycerides, diglycerides (positively) and Î³-aminobutyric acid (negatively).

```{r, fig.height=8}
load("data/clinical.Rdata")
clinical$V_MMSE <- NULL
df[,1:230] <- scale(df[,1:230])
AD <- subset(df, Diagnosis == "Probable AD")
AD$sex <- as.numeric(AD$sex) -1
# Testing for effects
gt.b <- globaltest::gt(E4 ~ 1, E4 ~ .-E4dose -Diagnosis -target, data = AD)
gt.b
globaltest::covariates(gt.b)
```

Performing a Global Test on ApoE4 dose shows distinct effects depeding on the number of ApoE4 alleles (p = 0.199).
```{r gt, fig.height=8}
# Multinomial outcome
AD$E4dose <- as.factor(AD$E4dose)
gt.m <- globaltest::gt(E4dose ~ 1, E4dose ~ .-E4 -Diagnosis -target, data = AD)
gt.m
globaltest::covariates(gt.m)
```

### Nested Linear Models
Metabolite-level models to test for ApoE4 dose effects. The F-tests yielded p-values < 0.05, however none of them survived FDR correction.
```{r}
nested <- function(Y, x, ...) {
  ### Analysis of Variance (ANOVA)
  x <- as.factor(x)
  df <- cbind(Y, x, ...)
  ncol <- ncol(Y)
  covariates <- names(...)
  F_tests <- furrr::future_map(df[, 1:ncol], ~ {
    frm <- as.formula(paste0(".x ~", paste(covariates, collapse = "+")))
    rm <- lm(frm, data = df)
    ffm <- as.formula(paste0(".x ~ x +", paste(covariates, collapse = "+")))
    fm <- lm(ffm, data = df)
    anova(rm, fm)
  })
  # Correction for Multiple Testing
  # Create a list to store the p-values
  p_values <- list(1:ncol)
  # Extract the p-values of the F-tests from the anova summaries list and store them in p_values
  for (i in 1:ncol) {
    p_values[[i]] <- F_tests[[i]][["Pr(>F)"]][[2]]
  }
  # Coerce p_values to dataframe and transpose it
  p_values <- t(data.frame(p_values))

  # Set as row names the metabolites
  p_values <- data.frame(p_values, row.names = colnames(Y))

  # Calculate the FDR-adjusted p-values
  p_values$p_adj <- p.adjust(p_values[, ], method = "fdr", n=230 )
  
  # Filter out the non-significant (a=0.05) FDR-adjusted p-values
  sig <- as.data.frame(dplyr::filter(p_values, p_values < 0.05))
  sig <- sig[order(sig$p_adj), ]
  cat("Significant F-tests: \n")
  print(sig)
  cat("\nDose effects on metabolites:")
  knitr::kable(sig)
  summaries <- furrr::future_map(df[, rownames(sig)], ~ {
    f <- as.formula(paste0(".x ~ x +", paste(covariates, collapse = "+")))
    mdl <- lm(f, data = df)
    summary(mdl)$coefficients[1:length(table(x)), ]
  })
  summaries <- lapply(summaries, function(x) {
    x <- x[, -c(2, 3)]
    x <- t(x)
  })
  summaries <- plyr::ldply(summaries, id = 1:2)
  return(knitr::kable(summaries, table.attr = "style='width:30%;'"))
}
```
### SCD and AD
The  metabolites most affected by ApoE4 dose are D-L-3-aminoisobutyric.acid, histamine, L-serine, ceramide d18:1/24:0, lysophosphatidylcholine 18:1, phosphatidylcholine 34:4, 36:6 and 40:4, sphingomyelin d18:1/22:0 and d18:1/24:0, LpH.PGE2, cLpH.PGA2, Lyso-phosphatidic acid 20:5 and taurine.
```{r}
Y <- df[, 1:230]
df$E4dose <- as.numeric(df$E4dose) -1
df$E4dose[df$E4dose == 0] <- "No ApoE4"
df$E4dose[df$E4dose == 1] <- "1 ApoE4"
df$E4dose[df$E4dose == 2] <- "2 ApoE4"
E4dose <- df$E4dose <- as.factor(df$E4dose)
## Testing for effects of ApoE4 dose
nested(Y, relevel(E4dose, ref= "No ApoE4"), clinical)
```

### AD group only
Among AD patients, ApoE4 dose seems to have an effect on several triglycerides, diglycerides, L-glutamic acid, L-lysine, 2- and 3-hydroxybutyric acid, glutamic acid, 3-phosphoglyceric acid, phosphatidylcholin, sphyngomyelin, HpH.PAF.C17, phosphoethanolamine, imino-diacetate.
```{r}
AD <- subset(df, Diagnosis == "Probable AD")
ADY <- AD[, 1:230]
ADE4dose <- AD$E4dose
ADclinical <- clinical[df$Diagnosis == "Probable AD",]

## Testing for effects of ApoE4 dose
nested(ADY, relevel(ADE4dose, ref= "No ApoE4"), ADclinical)
```

### SCD group only
Among individuals with SCD, lipid metabolites were not affected as much as in the AD group, with only LPC and PC showing a difference. Aminoacids (glycine, taurine, L-serine, serotonine, L-glutamic acid, L-glutamic acid, phosphoethanolamine) and oxidative stress compounds were mostly affected in this group.
```{r}
SCD <- df[df$Diagnosis == "Subjectieve klachten",]
SCDY <- SCD[, 1:230]
SCDE4dose <- SCD$E4dose
SCDclinical <- clinical[df$Diagnosis == "Subjectieve klachten",]

## Testing for effects of ApoE4 dose
nested(SCDY, relevel(SCDE4dose, ref= "No ApoE4"), SCDclinical)
```

## Multinomial Classification of ApoE4 presence and AD
The discriminative potential of the metabolites, correcting for clinical background features, on AD and ApoE4 or not (4-class response ADE4, AD, SCDE4, SCD)is assessed by first fitting a Multi-nomial Logistic Regression (benchmark model). The benchmark model fits only the clinical features. The model's AUC is compared with the same model (with altered hyperparameters) fitting clinical variables + 230 metabolites. The metabolites are then projected to 6 latent ML-estimated factors and 3 more models are fitted: Multi-nomial Logistic Regression, Decision Tree and XGBoost fitting clinical variables + 6 factors. The models' multi-class classification performance is compared using confusion matrices and AUCs.
```{r multifit}
multifit <- function(X,
                     y,
                     model,
                     ctrl = NULL,
                     grid = NULL,
                     seed = 87654, ...) {
  set.seed(seed)
  # Merge X and y into df
  df <- cbind.data.frame(X, y)
  # Train the model
  mdl <- caret::train(df[, 1:ncol(X)], df$y,
    method = model,
    tuneGrid = grid,
    trControl = ctrl,
    metric = "logLoss",
    ...
  )
  # Create a confusion matrix and get performance metrics from caret
  obs <- mdl$pred$obs
  preds <- mdl$pred$pred
  cm <- confusionMatrix(reference = obs, data = preds, mode = "everything")
  # Get the multi-class ROC curves
  ys <- as.numeric(obs) - 1
  yhats <- as.numeric(preds) - 1
  roc <- multiclass.roc(response = ys, predictor = yhats, quiet = T, legacy.axes = T)
  out <- list("cm" = cm, "roc" = roc, "model" = mdl)
  return(out)
}
# httpgd::hgd()
evaluate <- function(model){
print(model$roc$auc)
cat("\n")
print(model$cm)
names(model$roc$rocs) <- c("ADE4-AD", "ADE4-SCDE4", "ADE4-SCD", "AD-SCDE4", "AD-SCD", "SCDE4-SCD")
g <- ggroc(model$roc$rocs, legacy.axes = T) + scale_color_tableau() + theme_tufte() + guides(color = guide_legend(title = "ROC curves"))
ggplotly(g)
}
```

```{r multi_preparation}
load("data/data.Rdata")
X <- scale(df[, 1:230])
y <- df$target

Xclin = cbind.data.frame(X, clin_dummy)


ctrl <- trainControl(
  method = "repeatedcv",
  number = 10,
  repeats = 100,
  savePredictions = "final",
  classProbs = T,
  summaryFunction = multiClassSummary,
  selectionFunction = best,
  search = "random",
  sampling = "smote"
)
```

### Fitting a benchmark model: clinical characteristics only

```{r mlogit}
benchmark <- multifit(
  X = clin_dummy,
  y = y,
  model = "multinom",
  ctrl = ctrl,
  grid = expand.grid(decay = 0),
  trace = F
)

evaluate(benchmark)
```

### Regularized Multinomial Regression adding 230 metabolites

```{r}
mlr <- multifit(
  X = Xclin,
  y = y,
  model = "multinom",
  ctrl = ctrl,
  grid = expand.grid(decay = 10),
  trace = F
)

evaluate(mlr)
```

### Projection to Latent Factors

```{r get_thomson, results = FALSE}
project <- function(X, m, seed) {
  set.seed(seed)
  X <- scale(as.matrix(df[,1:230]))
  cov <- cor(X)

  # Find redundant features
  filter <- RF(cov)

  # Filter out redundant features
  filtered <- subSet(X, filter)

  # Regularized correlation matrix estimation
  M <- regcor(filtered)

  # Get the regularized correlation matrix of the filtered dataset
  R <- M$optCor

  mlfa <- mlFA(R, m = 6)
  thomson <- facScore(filtered, mlfa$Loadings, mlfa$Uniqueness)
  return(thomson)
}
```

```{r, results = FALSE}
thomson <- project(X, 6, seed = 1234)
X <- cbind(clin_dummy, thomson)
```

### Multinomial Logistic Regression adding 6 factors
```{r }
mlrf <- multifit(
  X = X,
  y = y,
  model = "multinom",
  ctrl = ctrl,
  trace = FALSE,
  grid = expand.grid(decay = 0)
)

evaluate(mlrf)
```

### Decision Tree

```{r multi_tree}
tree <- multifit(
  X = X,
  y = y,
  model = "rpart2",
  ctrl = ctrl,
  grid = expand.grid(maxdepth=3)
)

evaluate(tree)
```

### XGBoost Forest

```{r }
xgb <- multifit(
  X = X,
  y = y,
  model = "xgbTree",
  ctrl = ctrl,
  grid = xgb.grid
)

evaluate(xgb)
```
### Model Comparison
Observations:


1. Adding serum metabolite information (either the full 230-metabolite matrix or its 6-factor projection) seems to increase the discriminatory power of the models.  


2. Fitting 6 ML-estimated factors obtained by the FMradio package (cummulatively explaining 30% of variace) yields increased classification performance, serving as a valuable dimension reduction technique for high-dimensional data.


3. Looking at the confusion matrix and individual ROC curves, all models were able to discriminate better among certain classes (AD+E4/SCD+E4, AD+E4/SCD, AD-E4/SCD+E4 and AD-E4/SCD-E4) compared to others (AD+E4/AD-E4 and SCD+E4/SCD-E4).

```{r}
aucs <- data.frame(AUC = c("Clinical features only" = benchmark$roc$auc, "Clinical features + 230 metabolites" = mlr$roc$auc, "Clinical features + 6 latent factors" = mlrf$roc$auc, "Decision Tree" = tree$roc$auc, "XGBoost" = xgb$roc$auc))

knitr::kable(aucs)
```

## Metabolite Covariance Network Analysis in AD
The covariance network analysis shows distinct metabolic "images" among ApoE4 carriers and non-carriers in AD. The network vertices and edges are distinct. 
```{r preparation}
# Store all observations of ApoE4 non-carriers in C1
C1 <- scale(df[df$E4 == 0,1:230])
# Store all observations of ApoE4 carriers in C2
C2 <- scale(df[df$E4 == 1,1:230])

# Get the covariance matrices of C1 and C2
S1 <- covML(C1)
S2 <- covML(C2)

# Store them in a list
S <- list(S1 = S1, S2 = S2)

# Get the total number of samples
n <- c(nrow(S1), nrow(S2))

# Create a list of fused covariance matrices T
Ts <- default.target.fused(Slist = S, ns = n, type = "DUPV")
```

```{r, eval=FALSE}
# Get the optimal lambdas per class and fused with 10-fold CV
# set.seed(8910)
# optf <- optPenalty.fused(
#   Ylist = Ys,
#   Tlist = Ts,
#   lambda = default.penalty(Ys),
#   cv.method = "kCV",
#   k = 10,
#   verbose = FALSE
# )
# save(optf, file= "data/optf.Rdata")
```

```{r sparsify, echo = FALSE}
# Create a list of the two-class data Y
load("data/optf.Rdata")
Ys <- list(C1 = C1, C2 = C2)
Ps <- optf$Plist

Ps <- ridgeP.fused(S, n, Ts,lambda = optf$lambda, maxit = 1000)

# Get the sparsified high precision matrices, correcting FDR at .001
P0s <- sparsify.fused(Ps,
  threshold = "localFDR",
  FDRcut = 0.999
)
```
GGMs showing distinct metabolic compositions among ApoE4 carriers (left), non-carriers(middle) and the differential edges (right).
```{r GGMs per class and diff, message=FALSE, results = FALSE}
# Merge the sparse high precision matrices
TST <- Union(P0s$S1$sparseParCor, P0s$S2$sparseParCor)
PCE4NO <- TST$M1subset
PCE4YES <- TST$M2subset

# Create a color map per metabolite class
Colors <- rownames(PCE4YES)
Colors[grep("Am", rownames(PCE4YES))] <- "pink"
Colors[grep("OA", rownames(PCE4YES))] <- "lightblue"
Colors[grep("Lip", rownames(PCE4YES))] <- "yellow"
Colors[grep("OS", rownames(PCE4YES))] <- "purple"

set.seed(111213)
# Plot the sparsified ridge matrix of ApoE4 carriers with AD
Coords <- Ugraph(PCE4YES,
  type = "fancy", lay = "layout_with_fr",
  Vcolor = Colors, prune = FALSE, Vsize = 10, Vcex = 0.4,
  main = "ApoE4 carriers with AD"
)
# Plot he sparsified ridge matrix of ApoE4 non-carriers with AD
Ugraph(PCE4NO,
  type = "fancy", lay= NULL, coords = Coords,
  Vcolor = Colors, prune = FALSE, Vsize = 10, Vcex = 0.4,
  main = "ApoE4 non-carriers with AD"
)

# Plot the differential network
DiffGraph(PCE4NO, PCE4YES,
lay = NULL, coords = Coords,
  Vcolor = Colors, Vsize = 10, Vcex = 0.4,
  main = "Differential Network"
)
```

```{r centrality}
PC0list <- list(PCE4NO = PCE4NO, PCE4YES = PCE4YES)
# Get the network statistics
NetStats <- GGMnetworkStats.fused(PC0list)

NetStatsE4yes <- NetStats[,10:18]
NetStatsE4no <- NetStats[, 1:9]

NetStatsE4yes[, c(3, 9)] <- NetStatsE4no[, c(3, 9)] <- NULL
```
### Network statistics
```{r degree density plot }
# # Plot the densities of centrality degree scores
# plot(density(DegreesAD1[, 2]),
#   col = "blue", xlim = c(-1, 8), xlab = "Degree", main = ""
# )
# lines(density(DegreesAD2[, 2]),
#   col = "red"
# )
# legenda <- c("AD class 1", "AD class 2")
# legend(5, 0.5,
#   legend = legenda, 
#   lwd = rep(1, 2), lty = rep(1, 2), col = c("blue", "red"), cex = 0.7
# )
```
Wilcoxon Signed Rank test between the network statistics of ApoE4 carriers and non-carriers. The test shows distinct centrality degrees and average number of negative and positive edges.
```{r wilcoxon rank sum }
# Perform a Wilcoxon signed rank test

w <- furrr::future_map2(NetStatsE4yes[, 1:7], NetStatsE4no[, 1:7], ~ {
  wilcox.test(.x, .y, paired = TRUE, alternative = "greater")
})
p.values <- list(1:length(w))
for(i in 1:length(w)){
  p.values[i] <- w[[i]][['p.value']]
}
names(p.values) <- names(w)
p.values[p.values<0.05]
```
Distinct metabolite communities among ApoE4 carriers/non carriers
```{r communities}
# Get the communities per class
set.seed(141516)
CommC1 <- Communities(PCE4NO,
  Vcolor = Colors,
  Vsize = 10, Vcex = 0.5, main = "ApoE4 non-carriers"
)

CommC2 <- Communities(PCE4YES,
  Vcolor = Colors,
  Vsize = 10, Vcex = 0.5, main = "ApoE4 carriers"
)
```